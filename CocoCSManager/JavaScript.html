<script>
    /**
     * 2026 Coco CS Manager - 클라이언트 사이드 JavaScript
     */

    // ========== 네비게이션 히스토리 ========== 
    const navigationHistory = ['main'];
    let currentPage = 'main';

    // ========== 상태 관리 ========== 
    const appState = {
        selectedDate: null,
        selectedPart: null,
        selectedBranch: null,
        currentMonth: new Date().getMonth(),
        currentYear: new Date().getFullYear()
    };

    // ========== 페이지 네비게이션 ========== 

    /**
     * 특정 페이지로 이동
     * @param {string} pageId - 이동할 페이지 ID (page- 접두어 제외)
     */
    function navigateTo(pageId) {
        const targetPage = document.getElementById('page-' + pageId);
        if (!targetPage) {
            console.error('Page not found:', pageId);
            return;
        }

        // 현재 페이지 숨기기
        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });

        // 새 페이지 표시
        targetPage.classList.add('active');

        // 히스토리에 추가
        if (currentPage !== pageId) {
            navigationHistory.push(pageId);
            currentPage = pageId;
        }

        // 페이지별 초기화 작업
        onPageEnter(pageId);
    }

    /**
     * 이전 페이지로 이동
     */
    function goBack() {
        if (navigationHistory.length > 1) {
            navigationHistory.pop(); // 현재 페이지 제거
            const previousPage = navigationHistory[navigationHistory.length - 1];
            currentPage = previousPage;

            // 현재 페이지 숨기기
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });

            // 이전 페이지 표시
            const targetPage = document.getElementById('page-' + previousPage);
            if (targetPage) {
                targetPage.classList.add('active');
            }
        }
    }

    /**
     * 홈(메인)으로 이동
     */
    function goHome() {
        navigationHistory.length = 0;
        navigationHistory.push('main');
        currentPage = 'main';

        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });

        document.getElementById('page-main').classList.add('active');
    }

    /**
     * 페이지 진입 시 호출되는 함수
     * @param {string} pageId - 페이지 ID
     */
    function onPageEnter(pageId) {
        switch (pageId) {
            case 'cs-statistics':
                loadCSStatistics();
                break;
            // delivery-list: 자동 로드 삭제 - 검색 버튼으로 조회
        }
    }

    // ========== BS 및 리워크 검색 ========== 

    /**
     * BS 리워크 검색 실행
     */
    function searchBS() {
        const searchTerm = document.getElementById('bs-search-input').value.trim();
        const resultsContainer = document.getElementById('bs-search-results');

        if (!searchTerm) {
            showToast('자산번호를 입력해주세요.');
            return;
        }

        // 로딩 표시
        resultsContainer.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

        // 서버 호출
        google.script.run
            .withSuccessHandler(function (results) {
                displayBSResults(results);
            })
            .withFailureHandler(function (error) {
                resultsContainer.innerHTML = '<div class="empty-state"><span class="material-icons">error</span><p>검색 중 오류가 발생했습니다.</p></div>';
            })
            .searchBSRework(searchTerm);
    }

    /**
     * BS 검색 결과 표시
     * @param {Array} results - 검색 결과
     */
    function displayBSResults(results) {
        const resultsContainer = document.getElementById('bs-search-results');

        if (!results || results.length === 0) {
            resultsContainer.innerHTML = '<div class="empty-state"><span class="material-icons">search_off</span><p>검색 결과가 없습니다.</p></div>';
            return;
        }

        let html = '';
        results.forEach(item => {
            html += `
      <div class="result-item">
        <strong>${item.code}</strong>
        <div style="display: flex; justify-content: space-between; margin-top: 8px;">
          <span style="color: ${item.status === '완료' ? 'var(--success-green)' : 'var(--warning-orange)'}">${item.status}</span>
          <span style="color: var(--text-secondary)">${item.date}</span>
        </div>
      </div>
    `;
        });

        resultsContainer.innerHTML = html;
    }

    // ========== AS 실적 ========== 

    /**
     * 탭 전환
     * @param {HTMLElement} btn - 클릭된 버튼
     * @param {string} tab - 탭 ID
     */
    function switchTab(btn, tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        // 필요시 탭 콘텐츠 전환 로직 추가
    }

    /**
     * AS 실적 검색
     */
    function searchASPerformance() {
        const filters = {
            repairType: document.getElementById('repair-type').value,
            date: appState.selectedDate,
            part: document.getElementById('part-select').value,
            master: document.getElementById('master-select').value
        };

        const resultsContainer = document.getElementById('as-results');
        resultsContainer.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

        google.script.run
            .withSuccessHandler(function (results) {
                displayASResults(results);
            })
            .withFailureHandler(function (error) {
                resultsContainer.innerHTML = '<div class="empty-state"><span class="material-icons">error</span><p>조회 중 오류가 발생했습니다.</p></div>';
            })
            .getASPerformance(filters);
    }

    /**
     * AS 실적 결과 표시
     * @param {Array} results - AS 실적 목록
     */
    function displayASResults(results) {
        const resultsContainer = document.getElementById('as-results');

        if (!results || results.length === 0) {
            resultsContainer.innerHTML = '<div class="empty-state"><span class="material-icons">inbox</span><p>조회 결과가 없습니다.</p></div>';
            return;
        }

        let html = '';
        results.forEach(item => {
            html += `
      <div class="result-item">
        <div style="display: flex; justify-content: space-between;">
          <strong>${item.type}</strong>
          <span style="color: ${item.status === '완료' ? 'var(--success-green)' : 'var(--warning-orange)'}">${item.status}</span>
        </div>
        <div style="display: flex; justify-content: space-between; margin-top: 8px; color: var(--text-secondary);">
          <span>${item.part}</span>
          <span>${item.date}</span>
        </div>
      </div>
    `;
        });

        resultsContainer.innerHTML = html;
    }

    // ========== CS 통계 ========== 

    /**
     * CS 통계 로드
     */
    function loadCSStatistics() {
        google.script.run
            .withSuccessHandler(function (stats) {
                document.getElementById('stats-total').textContent = stats.total;
                document.getElementById('stats-completed').textContent = stats.completed;
                document.getElementById('stats-pending').textContent = stats.pending;
                document.getElementById('stats-rate').textContent = stats.rate + '%';
            })
            .withFailureHandler(function (error) {
                console.error('통계 로드 실패:', error);
            })
            .getCSStatistics('daily');
    }

    // ========== 영업점 검색 ========== 

    /**
     * 영업점 검색 실행
     */
    function searchBranch() {
        const searchTerm = document.getElementById('branch-search-input').value.trim();
        const resultsContainer = document.getElementById('branch-search-results');

        if (!searchTerm) {
            showToast('검색어를 입력해주세요.');
            return;
        }

        resultsContainer.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

        google.script.run
            .withSuccessHandler(function (results) {
                displayBranchResults(results);
            })
            .withFailureHandler(function (error) {
                resultsContainer.innerHTML = '<div class="empty-state"><span class="material-icons">error</span><p>검색 중 오류가 발생했습니다.</p></div>';
            })
            .searchBranchAddress(searchTerm);
    }

    /**
     * 영업점 검색 결과 표시
     * @param {Array} results - 영업점 목록
     */
    function displayBranchResults(results) {
        const resultsContainer = document.getElementById('branch-search-results');

        if (!results || results.length === 0) {
            resultsContainer.innerHTML = '<div class="empty-state"><span class="material-icons">store_off</span><p>검색 결과가 없습니다.</p></div>';
            return;
        }

        let html = '';
        results.forEach(branch => {
            html += `
      <div class="result-item" onclick="showBranchDetail(${JSON.stringify(branch).replace(/"/g, '&quot;')})">
        <div style="display: flex; align-items: center; gap: 8px;">
          <span class="material-icons" style="color: var(--primary-blue);">store</span>
          <strong>${branch.name}</strong>
        </div>
        <p style="margin-top: 8px; color: var(--text-secondary); font-size: 13px;">${branch.address}</p>
      </div>
    `;
        });

        resultsContainer.innerHTML = html;
    }

    /**
     * 영업점 상세 표시
     * @param {Object} branch - 영업점 정보
     */
    function showBranchDetail(branch) {
        appState.selectedBranch = branch;

        // 상세 정보 채우기
        document.getElementById('branch-detail-input').value = branch.name;
        document.getElementById('detail-branch-name').textContent = branch.name;
        document.getElementById('detail-address').textContent = branch.address;
        document.getElementById('detail-phone').textContent = branch.phone;
        document.getElementById('detail-phone').href = 'tel:' + branch.phone;
        document.getElementById('detail-manager').textContent = branch.manager;
        document.getElementById('detail-manager').href = 'tel:' + branch.manager;
        document.getElementById('detail-count').textContent = branch.stats.count;
        document.getElementById('detail-sales').textContent = branch.stats.sales;
        document.getElementById('detail-service').textContent = branch.stats.service;

        navigateTo('branch-detail');
    }

    // ========== 배차 목록 ========== 

    /**
     * 배차 목록 로드
     */
    function loadDeliveryList() {
        const resultsContainer = document.getElementById('delivery-results');
        resultsContainer.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

        google.script.run
            .withSuccessHandler(function (results) {
                displayDeliveryList(results);
            })
            .withFailureHandler(function (error) {
                resultsContainer.innerHTML = '<div class="empty-state"><span class="material-icons">error</span><p>목록 로드 중 오류가 발생했습니다.</p></div>';
            })
            .getDeliveryList();
    }

    /**
     * 배차 목록 표시
     * @param {Array} results - 배차 목록
     */
    function displayDeliveryList(results) {
        const resultsContainer = document.getElementById('delivery-results');

        if (!results || results.length === 0) {
            resultsContainer.innerHTML = '<div class="empty-state"><span class="material-icons">local_shipping</span><p>배차 목록이 없습니다.</p></div>';
            return;
        }

        let html = '';
        results.forEach(item => {
            html += `
      <div class="result-item">
        <div style="display: flex; justify-content: space-between;">
          <strong>${item.driver}</strong>
          <span style="color: ${item.status === '배송중' ? 'var(--success-green)' : 'var(--text-secondary)'}">${item.status}</span>
        </div>
        <p style="margin-top: 8px; color: var(--text-secondary);">차량: ${item.vehicle}</p>
      </div>
    `;
        });

        resultsContainer.innerHTML = html;
    }

    // ========== 배차일 선택 ========== 

    /**
     * 배차일 선택 팝업 열기
     */
    function openDeliveryDatePicker() {
        appState.datePickerTarget = 'delivery';
        renderCalendar();
        document.getElementById('date-picker-modal').classList.add('active');
    }

    /**
     * 배차 목록 검색
     */
    function searchDeliveryList() {
        if (!appState.selectedDeliveryDate) {
            showToast('배차일을 선택해주세요.');
            return;
        }

        const resultsContainer = document.getElementById('delivery-results');
        resultsContainer.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

        google.script.run
            .withSuccessHandler(function (results) {
                displayDeliveryList(results);
            })
            .withFailureHandler(function (error) {
                resultsContainer.innerHTML = '<div class="empty-state"><span class="material-icons">error</span><p>목록 로드 중 오류가 발생했습니다.</p></div>';
            })
            .getDeliveryList(appState.selectedDeliveryDate);
    }

    // ========== 날짜 선택 (달력) ========== 

    /**
     * 날짜 선택 팝업 열기
     */
    function openDatePicker() {
        renderCalendar();
        document.getElementById('date-picker-modal').classList.add('active');
    }

    /**
     * 날짜 선택 팝업 닫기
     */
    function closeDatePicker() {
        document.getElementById('date-picker-modal').classList.remove('active');
    }

    /**
     * 달력 렌더링
     */
    function renderCalendar() {
        const year = appState.currentYear;
        const month = appState.currentMonth;

        // 월 표시 업데이트
        const monthNames = ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'];
        document.getElementById('calendar-month').textContent = `${monthNames[month]} ${year}`;

        // 해당 월의 첫날과 마지막 날
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startDayOfWeek = firstDay.getDay();
        const daysInMonth = lastDay.getDate();

        // 이전 달 마지막 날짜들
        const prevMonthLastDay = new Date(year, month, 0).getDate();

        // 오늘 날짜
        const today = new Date();
        const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;

        let html = '';

        // 이전 달 날짜
        for (let i = startDayOfWeek - 1; i >= 0; i--) {
            const day = prevMonthLastDay - i;
            html += `<div class="calendar-day other-month">${day}</div>`;
        }

        // 현재 달 날짜
        for (let day = 1; day <= daysInMonth; day++) {
            const dayOfWeek = (startDayOfWeek + day - 1) % 7;
            let classes = 'calendar-day';

            if (dayOfWeek === 0) classes += ' sunday';
            if (dayOfWeek === 6) classes += ' saturday';
            if (isCurrentMonth && day === today.getDate()) classes += ' today';

            // 선택된 날짜 확인
            if (appState.selectedDate) {
                const selected = new Date(appState.selectedDate);
                if (selected.getFullYear() === year && selected.getMonth() === month && selected.getDate() === day) {
                    classes += ' selected';
                }
            }

            html += `<div class="${classes}" onclick="selectDate(${year}, ${month}, ${day})">${day}</div>`;
        }

        // 다음 달 날짜 (6주 채우기)
        const totalCells = Math.ceil((startDayOfWeek + daysInMonth) / 7) * 7;
        const remainingCells = totalCells - (startDayOfWeek + daysInMonth);
        for (let day = 1; day <= remainingCells; day++) {
            html += `<div class="calendar-day other-month">${day}</div>`;
        }

        document.getElementById('calendar-days').innerHTML = html;
    }

    /**
     * 이전 달로 이동
     */
    function prevMonth() {
        appState.currentMonth--;
        if (appState.currentMonth < 0) {
            appState.currentMonth = 11;
            appState.currentYear--;
        }
        renderCalendar();
    }

    /**
     * 다음 달로 이동
     */
    function nextMonth() {
        appState.currentMonth++;
        if (appState.currentMonth > 11) {
            appState.currentMonth = 0;
            appState.currentYear++;
        }
        renderCalendar();
    }

    /**
     * 날짜 선택
     * @param {number} year - 년도
     * @param {number} month - 월 (0-11)
     * @param {number} day - 일
     */
    function selectDate(year, month, day) {
        const date = new Date(year, month, day);
        const dateStr = date.toISOString().split('T')[0];
        const displayDate = `${year}년 ${month + 1}월 ${day}일`;

        // 배차일 선택인 경우
        if (appState.datePickerTarget === 'delivery') {
            appState.selectedDeliveryDate = dateStr;
            document.getElementById('selected-delivery-date').textContent = displayDate;
        } else {
            // AS 실적 날짜 선택
            appState.selectedDate = dateStr;
            document.getElementById('selected-date').textContent = displayDate;
        }

        appState.datePickerTarget = null;
        closeDatePicker();
    }

    // ========== 파트 선택 ========== 

    /**
     * 파트 선택 팝업 열기
     */
    function openPartPicker() {
        document.getElementById('part-picker-modal').classList.add('active');
    }

    /**
     * 파트 선택 팝업 닫기
     */
    function closePartPicker() {
        document.getElementById('part-picker-modal').classList.remove('active');
    }

    /**
     * 파트 선택 확인
     */
    function selectPart() {
        const selected = document.querySelector('input[name="part"]:checked');
        if (selected) {
            appState.selectedPart = selected.value;
            document.getElementById('selected-part').textContent = selected.value;
        }
        closePartPicker();
    }

    // ========== 지도 관련 ========== 

    /**
     * 네이버 지도 열기
     */
    function openNaverMap() {
        if (appState.selectedBranch) {
            const address = encodeURIComponent(appState.selectedBranch.address);
            const url = `https://map.naver.com/v5/search/${address}`;
            window.open(url, '_blank');
        }
    }

    /**
     * 주소 복사
     */
    function copyAddress() {
        if (appState.selectedBranch) {
            const address = appState.selectedBranch.address;

            if (navigator.clipboard) {
                navigator.clipboard.writeText(address).then(function () {
                    showToast('주소가 복사되었습니다.');
                });
            } else {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = address;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showToast('주소가 복사되었습니다.');
            }
        }
    }

    // ========== 유틸리티 ========== 

    /**
     * 토스트 메시지 표시
     * @param {string} message - 표시할 메시지
     */
    function showToast(message) {
        // 기존 토스트 제거
        const existingToast = document.querySelector('.toast');
        if (existingToast) {
            existingToast.remove();
        }

        // 새 토스트 생성
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = message;
        toast.style.cssText = `
    position: fixed;
    bottom: 80px;
    left: 50%;
    transform: translateX(-50%);
    background-color: rgba(0,0,0,0.8);
    color: white;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 14px;
    z-index: 2000;
    animation: fadeIn 0.3s ease-out;
  `;

        document.body.appendChild(toast);

        // 3초 후 제거
        setTimeout(function () {
            toast.style.animation = 'fadeOut 0.3s ease-out';
            setTimeout(function () {
                toast.remove();
            }, 300);
        }, 3000);
    }

    // ========== 초기화 ========== 
    document.addEventListener('DOMContentLoaded', function () {
        console.log('2026 Coco CS Manager 초기화 완료');

        // 초기 페이지 표시
        navigateTo('main');
    });
</script>

<style>
    @keyframes fadeOut {
        from {
            opacity: 1;
        }

        to {
            opacity: 0;
        }
    }
</style>